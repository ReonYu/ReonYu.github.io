<!DOCTYPE html>


<html lang="zh-HK" >


<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="路漫漫其修远兮，吾将上下而求索" />
   
  <meta name="description" content="挪威的森林" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    Mybatis 动态sql |  Leon
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/first.png" />
  
  <link rel="stylesheet" href="/dist/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  <div id="app">
    <main class="content on">
      <section class="outer">
  <article id="post-Mybatis-动态sql" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Mybatis 动态sql
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/Mybatis-动态sql/" class="article-date">
  <time datetime="2018-05-20T13:41:10.000Z" itemprop="datePublished">2018-05-20</time>
</a>
      
      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">4.1k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">21 min</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    




    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <p>在报表类应用中，通常需要根据不同的维度去组合复杂的查询条件，然后构造SQL去执行查询。如果只是通过在程序中简单地拼接SQL语句，工作量会非常大，而且代码可能也非常难以维护。Mybatis支持动态SQL查询功能，可以通过配置动态的SQL来简化程序代码中复杂性，不过，这个颇有点XML编程的韵味，通过XML来处理复杂的数据判断、循环的功能，其实也很好理解。</p>
 <a id="more"></a>

<p>建表:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `traffic_info` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `domain` varchar(64) NOT NULL,</span><br><span class="line">  `traffic_host` varchar(64) NOT NULL,</span><br><span class="line">  `month` varchar(8) NOT NULL,</span><br><span class="line">  `monthly_traffic` int(11) DEFAULT &apos;0&apos;,</span><br><span class="line">  `global_traffic_rank` int(11) DEFAULT &apos;0&apos;,</span><br><span class="line">  `native_traffic_rank` int(11) DEFAULT &apos;0&apos;,</span><br><span class="line">  `rank_in_country` varchar(64) DEFAULT NULL,</span><br><span class="line">  `address` varchar(200) DEFAULT NULL,</span><br><span class="line">  `email` varchar(50) DEFAULT NULL,</span><br><span class="line">  `traffic_type` int(2) DEFAULT &apos;-1&apos;,</span><br><span class="line">  `status` int(2) DEFAULT &apos;0&apos;,</span><br><span class="line">  `created_at` date DEFAULT NULL,</span><br><span class="line">  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  `f1` varchar(255) DEFAULT NULL,</span><br><span class="line">  `f2` varchar(255) DEFAULT NULL,</span><br><span class="line">  `f3` varchar(255) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `idx_traffic` (`domain`,`month`,`traffic_type`)</span><br><span class="line">) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>

<p>这个表用来存储域名的流量信息，流量信息我们从互联网上像Alexa、Compete、Quantcast等提供商获取，通过Crawler抓取的方式实现。我们先从简单的查询做起，只是根据某个字段进行查询，说明如何配置使用Mybatis，这里面也包含如何与Spring进行集成。</p>
<p>配置实践</p>
<p>下面是用到的一些资源的定义：</p>
<p>org.shirdrn.mybatis.TrafficInfo类<br>该类对应于traffic_info表中一条记录的数据，我们简单取几个字段，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package org.shirdrn.mybatis;</span><br><span class="line"> </span><br><span class="line">import java.io.Serializable;</span><br><span class="line"> </span><br><span class="line">public class TrafficInfo implements Serializable &#123;</span><br><span class="line">     </span><br><span class="line">     private static final long serialVersionUID = -8696613205078899594L;</span><br><span class="line">     int id;</span><br><span class="line">     String domain;</span><br><span class="line">     String month;</span><br><span class="line">     int monthlyTraffic;</span><br><span class="line">     </span><br><span class="line">     public int getId() &#123;</span><br><span class="line">          return id;</span><br><span class="line">     &#125;</span><br><span class="line">     public void setId(int id) &#123;</span><br><span class="line">          this.id = id;</span><br><span class="line">     &#125;</span><br><span class="line">     public String getDomain() &#123;</span><br><span class="line">          return domain;</span><br><span class="line">     &#125;</span><br><span class="line">     public void setDomain(String domain) &#123;</span><br><span class="line">          this.domain = domain;</span><br><span class="line">     &#125;</span><br><span class="line">     public String getMonth() &#123;</span><br><span class="line">          return month;</span><br><span class="line">     &#125;</span><br><span class="line">     public void setMonth(String month) &#123;</span><br><span class="line">          this.month = month;</span><br><span class="line">     &#125;</span><br><span class="line">     public int getMonthlyTraffic() &#123;</span><br><span class="line">          return monthlyTraffic;</span><br><span class="line">     &#125;</span><br><span class="line">     public void setMonthlyTraffic(int monthlyTraffic) &#123;</span><br><span class="line">          this.monthlyTraffic = monthlyTraffic;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     @Override</span><br><span class="line">     public String toString() &#123;</span><br><span class="line">          return &quot;[id=&quot; + id + &quot;, domain=&quot; + domain + &quot;, month=&quot; +</span><br><span class="line">                    month + &quot;, monthlyTraffic=&quot; + monthlyTraffic + &quot;]&quot;;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.shirdrn.mybatis.mapper.TrafficInfoMapper接口类<br>该类定义了一个与SQL配置进行映射的基本操作，实际的SQL配置有专门的XML文件来进行配置。该接口定义了如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package org.shirdrn.mybatis.mapper;</span><br><span class="line"> </span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"> </span><br><span class="line">import org.shirdrn.mybatis.TrafficInfo;</span><br><span class="line"> </span><br><span class="line">public interface TrafficInfoMapper &#123;</span><br><span class="line"> </span><br><span class="line">     /**</span><br><span class="line">     * 根据指定id去查询记录，结果至多只有一条</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">     TrafficInfo getTrafficInfo(int id);</span><br><span class="line">     </span><br><span class="line">     /**</span><br><span class="line">     * 根据指定的domain参数查询记录，返回一个记录的列表</span><br><span class="line">     * @param domain</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">     List&lt;TrafficInfo&gt; getTrafficInfoList(String domain);</span><br><span class="line">     </span><br><span class="line">     /**</span><br><span class="line">     * 根据一个 字段domain进行查询，但是存在多个domain的值，传入一个数组</span><br><span class="line">     * @param domains</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">     List&lt;TrafficInfo&gt; getMultiConditionsList(String[] domains);</span><br><span class="line">     </span><br><span class="line">     /**</span><br><span class="line">     * 根据多个字段进行查询，每个字段可能有多个值，所以参数是Map类型</span><br><span class="line">     * @param conditions</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">     List&lt;TrafficInfo&gt; getMapConditionsList(Map&lt;String, Object&gt; conditions);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面接口中定义的操作，一个比一个复杂，我们通过这一系列操作来说明在Mybatis中如果使用各种查询功能。</p>
<p>org/shirdrn/mybatis/mapper/TrafficInfoMapper.xml映射配置文件<br>这个文件TrafficInfoMapper.xml对应了上面的org.shirdrn.mybatis.mapper.TrafficInfoMapper中定义的操作，通过XML的方式将对应的SQL查询构造出来，这个是Mybatis的核心功能。该文件的内容示例如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; </span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line"> </span><br><span class="line">&lt;mapper namespace=&quot;org.shirdrn.mybatis.mapper.TrafficInfoMapper&quot;&gt;</span><br><span class="line">     &lt;resultMap type=&quot;TrafficInfo&quot; id=&quot;tfMap&quot;&gt;</span><br><span class="line">          &lt;id property=&quot;id&quot; column=&quot;id&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;domain&quot; column=&quot;domain&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;month&quot; column=&quot;month&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;monthlyTraffic&quot; column=&quot;monthlyTraffic&quot; /&gt;</span><br><span class="line">     &lt;/resultMap&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;select id=&quot;getTrafficInfo&quot; resultType=&quot;TrafficInfo&quot; parameterType=&quot;int&quot;&gt;</span><br><span class="line">          SELECT * FROM domain_db.traffic_info WHERE id = #&#123;id&#125;</span><br><span class="line">     &lt;/select&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;select id=&quot;getTrafficInfoList&quot; resultType=&quot;TrafficInfo&quot; parameterType=&quot;string&quot;&gt;</span><br><span class="line">          SELECT * FROM domain_db.traffic_info WHERE domain = #&#123;domain&#125;</span><br><span class="line">     &lt;/select&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;select id=&quot;getMultiConditionsList&quot; resultMap=&quot;tfMap&quot;&gt;</span><br><span class="line">          SELECT * FROM domain_db.traffic_info WHERE domain IN</span><br><span class="line">          &lt;foreach collection=&quot;array&quot; index=&quot;index&quot; item=&quot;domain&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt; </span><br><span class="line">             #&#123;domain&#125; </span><br><span class="line">         &lt;/foreach&gt;</span><br><span class="line">     &lt;/select&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;select id=&quot;getMapConditionsList&quot; resultMap=&quot;tfMap&quot;&gt;</span><br><span class="line">          SELECT * FROM domain_db.traffic_info WHERE domain IN</span><br><span class="line">          &lt;foreach collection=&quot;domains&quot; index=&quot;index&quot; item=&quot;domain&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt; </span><br><span class="line">             #&#123;domain&#125; </span><br><span class="line">         &lt;/foreach&gt;</span><br><span class="line">         AND status = 0 AND month IN</span><br><span class="line">         &lt;foreach collection=&quot;months&quot; index=&quot;index&quot; item=&quot;month&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt; </span><br><span class="line">             #&#123;month&#125; </span><br><span class="line">         &lt;/foreach&gt;</span><br><span class="line">     &lt;/select&gt;</span><br><span class="line"> </span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<p>如果你之前用过ibatis，应该很熟悉上面这个配置文件。上面：<br>namespace指定该SQL映射配置文件的Mapper接口类，其中定义了基本的SQL查询操作（以我们给出的例子为例）；<br>resultMap中的type的值这里是一个别名，当然也可以使用对应的具体类全名（包名+类名），我们会在Mybatis的总的映射配置文件中进行配置，详见后面说明；<br>select是查询SQL的配置，可以通过不同的元素进行动态构造，如if、foreach等；</p>
<p>Mybatis全局映射配置文件sqlMapConfig.xml<br>该文件可以指定数据库连接池配置、别名配置、SQL映射配置文件组等内容，这里示例的配置内容如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line"> </span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">     &lt;typeAliases&gt;</span><br><span class="line">          &lt;typeAlias type=&quot;org.shirdrn.mybatis.TrafficInfo&quot; alias=&quot;TrafficInfo&quot; /&gt;</span><br><span class="line">     &lt;/typeAliases&gt;</span><br><span class="line">     &lt;mappers&gt;</span><br><span class="line">          &lt;mapper resource=&quot;org/shirdrn/mybatis/mapper/TrafficInfoMapper.xml&quot; /&gt;</span><br><span class="line">     &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>Spring配置文件applicationContext.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">     xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">     xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">     xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line"> </span><br><span class="line">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">http://www.springframework.org/schema/context</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">http://www.springframework.org/schema/context/spring-context-3.0.xsd</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">http://www.springframework.org/schema/aop</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">http://www.springframework.org/schema/aop/spring-aop-3.0.xsd</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">http://www.springframework.org/schema/tx</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">http://www.springframework.org/schema/tx/spring-tx-3.0.xsd&quot;&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;bean</span><br><span class="line">          class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;</span><br><span class="line">          &lt;property name=&quot;systemPropertiesModeName&quot; value=&quot;SYSTEM_PROPERTIES_MODE_OVERRIDE&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;ignoreResourceNotFound&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;locations&quot;&gt;</span><br><span class="line">               &lt;list&gt;</span><br><span class="line">                    &lt;value&gt;classpath*:/proxool.properties&lt;/value&gt;</span><br><span class="line">               &lt;/list&gt;</span><br><span class="line">          &lt;/property&gt;</span><br><span class="line">     &lt;/bean&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;context:component-scan base-package=&quot;org.shirdrn.mybatis&quot; /&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot; /&gt;</span><br><span class="line">     &lt;aop:config proxy-target-class=&quot;true&quot; /&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;bean id=&quot;dataSource&quot; class=&quot;org.shirdrn.mybatis.utils.ProxoolDataSource&quot;&gt;</span><br><span class="line">          &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc-0.proxool.driver-class&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;driverUrl&quot; value=&quot;$&#123;jdbc-0.proxool.driver-url&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;user&quot; value=&quot;$&#123;jdbc-0.user&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc-0.password&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;alias&quot; value=&quot;$&#123;jdbc-0.proxool.alias&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;prototypeCount&quot; value=&quot;$&#123;jdbc-0.proxool.prototype-count&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;maximumActiveTime&quot; value=&quot;$&#123;jdbc-0.proxool.maximum-active-time&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;maximumConnectionCount&quot; value=&quot;$&#123;jdbc-0.proxool.maximum-connection-count&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;minimumConnectionCount&quot; value=&quot;$&#123;jdbc-0.proxool.minimum-connection-count&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;simultaneousBuildThrottle&quot;</span><br><span class="line">               value=&quot;$&#123;jdbc-0.proxool.simultaneous-build-throttle&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;verbose&quot; value=&quot;$&#123;jdbc-0.proxool.verbose&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;trace&quot; value=&quot;$&#123;jdbc-0.proxool.trace&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;houseKeepingTestSql&quot; value=&quot;$&#123;jdbc-0.proxool.house-keeping-test-sql&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;houseKeepingSleepTime&quot; value=&quot;$&#123;jdbc-0.proxool.house-keeping-sleep-time&#125;&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;maximumConnectionLifetime&quot;</span><br><span class="line">               value=&quot;$&#123;jdbc-0.proxool.maximum-connection-lifetime&#125;&quot; /&gt;</span><br><span class="line">     &lt;/bean&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;bean id=&quot;dataSource0&quot; class=&quot;org.jdbcdslog.ConnectionPoolDataSourceProxy&quot;&gt;</span><br><span class="line">          &lt;property name=&quot;targetDSDirect&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">     &lt;/bean&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;!-- http://mybatis.github.io/spring/getting-started.html --&gt;</span><br><span class="line">     &lt;!-- http://mybatis.github.io/spring/zh/ --&gt;</span><br><span class="line">     &lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">          &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource0&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;configLocation&quot; value=&quot;classpath:sqlMapConfig.xml&quot;/&gt;</span><br><span class="line">     &lt;/bean&gt;</span><br><span class="line">     &lt;bean id=&quot;trafficInfoMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;</span><br><span class="line">          &lt;property name=&quot;mapperInterface&quot; value=&quot;org.shirdrn.mybatis.mapper.TrafficInfoMapper&quot; /&gt;</span><br><span class="line">          &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line">     &lt;/bean&gt;</span><br><span class="line">     &lt;bean id=&quot;trafficInfoService&quot; class=&quot;org.shirdrn.mybatis.TrafficInfoService&quot;&gt;</span><br><span class="line">          &lt;property name=&quot;trafficInfoMapper&quot; ref=&quot;trafficInfoMapper&quot; /&gt;</span><br><span class="line">     &lt;/bean&gt;</span><br><span class="line"> </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>简单说明一下：<br>dataSource使用的Proxool连接池组件；<br>sqlSessionFactory是Mybatis的SessionFactory，注入了前面获取到的dataSource，同时指定了Mybatis的总的映射配置文件classpath:sqlMapConfig.xml，属性名为configLocation；<br>trafficInfoMapper直接由Spring的org.mybatis.spring.mapper.MapperFactoryBean进行代理，需要注入属性mapperInterface（即我们定义的SQL Mapper操作的接口类）和sqlSessionFactory（前面的SessionFactory实例）；<br>trafficInfoService是我们最终在其中进行调用的服务类，注入了我们定义的SQL Mapper接口类的实例trafficInfoMapper。</p>
<p>org.shirdrn.mybatis.TrafficInfoService服务类<br>为简单起见，我们就不定义服务接口了，直接在该类中实现，调用SQL Mapper中预定义的SQL查询操作，实现代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package org.shirdrn.mybatis;</span><br><span class="line"> </span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"> </span><br><span class="line">import org.shirdrn.mybatis.mapper.TrafficInfoMapper;</span><br><span class="line"> </span><br><span class="line">public class TrafficInfoService &#123;</span><br><span class="line"> </span><br><span class="line">     private TrafficInfoMapper trafficInfoMapper;</span><br><span class="line">     </span><br><span class="line">     public void setTrafficInfoMapper(TrafficInfoMapper trafficInfoMapper) &#123;</span><br><span class="line">          this.trafficInfoMapper = trafficInfoMapper;</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">     public TrafficInfo getTrafficInfo(int id) &#123;</span><br><span class="line">          return trafficInfoMapper.getTrafficInfo(id);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     public List&lt;TrafficInfo&gt; getTrafficInfoList(String domain) &#123;</span><br><span class="line">          return trafficInfoMapper.getTrafficInfoList(domain);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     public List&lt;TrafficInfo&gt; getMultiConditionsList(String[] domains) &#123;</span><br><span class="line">          return trafficInfoMapper.getMultiConditionsList(domains);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     List&lt;TrafficInfo&gt; getMapConditionsList(Map&lt;String, Object&gt; conditions) &#123;</span><br><span class="line">          return trafficInfoMapper.getMapConditionsList(conditions);</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照上面的配置，我们就能够实现从单个字段的查询，到多个字段的组合复杂查询。可以通过与实际编写代码来控制这些逻辑相比较，使用Mybatis可能配置上相对复杂一些，但是或得到的好处是非常多的，如代码可维护性好，看起来配置比较直观，出错的几率会大大减小。实际上，如果熟练的这种配置方式，就会在实际开发过程中，更好地去处理更加复杂的统计查询条件的组合逻辑。</p>
<p>测试用例</p>
<p>测试用例可以检测我们上面的配置是否生效，实现代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">package org.shirdrn.mybatis;</span><br><span class="line"> </span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"> </span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.test.context.ContextConfiguration;</span><br><span class="line">import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"> </span><br><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@ContextConfiguration(locations = &#123; &quot;classpath:/applicationContext*.xml&quot; &#125;)</span><br><span class="line">public class TestTrafficInfoService &#123;</span><br><span class="line"> </span><br><span class="line">     @Autowired</span><br><span class="line">     private TrafficInfoService trafficInfoService;</span><br><span class="line"> </span><br><span class="line">     @Test</span><br><span class="line">     public void getTraffic() &#123;</span><br><span class="line">          int id = 1196;</span><br><span class="line">          TrafficInfo result = trafficInfoService.getTrafficInfo(id);</span><br><span class="line">          System.out.println(result);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     @Test</span><br><span class="line">     public void getTrafficList() &#123;</span><br><span class="line">          String domain = &quot;make-the-cut.com&quot;;</span><br><span class="line">          List&lt;TrafficInfo&gt; results = trafficInfoService.getTrafficInfoList(domain);</span><br><span class="line">          System.out.println(results);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     @Test</span><br><span class="line">     public void getMultiConditionsList() &#123;</span><br><span class="line">          String[] domains = new String[] &#123;</span><br><span class="line">                    &quot;make.tv&quot;, &quot; make-the-cut.com&quot;, &quot;makgrills.com&quot;, &quot;makino.com&quot;</span><br><span class="line">          &#125;;</span><br><span class="line">          List&lt;TrafficInfo&gt; results = trafficInfoService.getMultiConditionsList(domains);</span><br><span class="line">          System.out.println(results);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     @Test</span><br><span class="line">     public void getMapConditionsList() &#123;</span><br><span class="line">          String[] domains = new String[] &#123;</span><br><span class="line">                    &quot;make.tv&quot;, &quot; make-the-cut.com&quot;, &quot;makgrills.com&quot;, &quot;makino.com&quot;</span><br><span class="line">          &#125;;</span><br><span class="line">          List&lt;String&gt; months = Arrays.asList(new String[] &#123;</span><br><span class="line">                    &quot;201203&quot;, &quot;201204&quot;, &quot;201205&quot;</span><br><span class="line">          &#125;);</span><br><span class="line">          Map&lt;String, Object&gt; conditions = new HashMap&lt;String, Object&gt;(2);</span><br><span class="line">          conditions.put(&quot;domains&quot;, domains);</span><br><span class="line">          conditions.put(&quot;months&quot;, months);</span><br><span class="line">          List&lt;TrafficInfo&gt; results = trafficInfoService.getMapConditionsList(conditions);</span><br><span class="line">          System.out.println(results);</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询进阶</p>
<p>这里，给出一个实际的例子，是对每日报表的一个统计实例，为简单起见，只拿出2张表做LEFT JOIN连接。这个需求，要求查询时可以对每个维度取过得查询条件值，如对于维度osName，值可以使包含Android、IOS，对于另一个维度statDate，可以取最近2天（昨天和前天），等等，并且，这些组合条件可有可无。<br>对应的Mybatis映射配置文件，内容如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; </span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line"> </span><br><span class="line">&lt;mapper namespace=&quot;org.shirdrn.data.mappers.DailyAppUserMapper&quot;&gt;</span><br><span class="line">     &lt;resultMap id=&quot;dailyAppUserMap&quot; type=&quot;DailyAppUser&quot;&gt;</span><br><span class="line">          &lt;id property=&quot;id&quot; column=&quot;id&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;primaryCategoryId&quot; column=&quot;primary_category_id&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;primaryCategoryName&quot; column=&quot;primary_category_name&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;secondaryCategoryId&quot; column=&quot;secondary_category_id&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;secondaryCategoryName&quot; column=&quot;secondary_category_name&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;cooperationMode&quot; column=&quot;cooperation_mode&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;merchantId&quot; column=&quot;merchant_id&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;merchantName&quot; column=&quot;merchant_name&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;osName&quot; column=&quot;osName&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;channelId&quot; column=&quot;channel_id&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;channelName&quot; column=&quot;channel_name&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;version&quot; column=&quot;version&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;statDate&quot; column=&quot;stat_date&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;newUserOpen&quot; column=&quot;new_user_open&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;activeUserOpen&quot; column=&quot;active_user_open&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;activeUserPlay&quot; column=&quot;active_user_play&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;oldUserOpen&quot; column=&quot;old_user_open&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;oldUserPlay&quot; column=&quot;old_user_play&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;averageTime&quot; column=&quot;average_time&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;newUserAverageTime&quot; column=&quot;new_user_average_time&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;oldUserAverageTime&quot; column=&quot;old_user_average_time&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;newUserOpen2Retention&quot; column=&quot;new_user_open_2retention&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;newUserOpen3Retention&quot; column=&quot;new_user_open_3retention&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;newUserOpen7Retention&quot; column=&quot;new_user_open_7retention&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;newUserOpen15Retention&quot; column=&quot;new_user_open_15retention&quot; /&gt;</span><br><span class="line">          &lt;result property=&quot;newUserOpen30Retention&quot; column=&quot;new_user_open_30retention&quot; /&gt;</span><br><span class="line">     &lt;/resultMap&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;select id=&quot;getDailyAppUserListByPage&quot; resultMap=&quot;dailyAppUserMap&quot;&gt;</span><br><span class="line">          &lt;include refid=&quot;getDailyAppUserList&quot;/&gt;</span><br><span class="line">          LIMIT #&#123;offset&#125;, #&#123;limit&#125;</span><br><span class="line">     &lt;/select&gt;</span><br><span class="line">      </span><br><span class="line">     &lt;select id=&quot;getDailyAppUserListForReport&quot; resultMap=&quot;dailyAppUserMap&quot;&gt;</span><br><span class="line">          &lt;include refid=&quot;getDailyAppUserList&quot;/&gt;</span><br><span class="line">     &lt;/select&gt;</span><br><span class="line">      </span><br><span class="line">     &lt;sql id=&quot;getDailyAppUserList&quot; &gt;</span><br><span class="line">          SELECT </span><br><span class="line">               d.id AS id,</span><br><span class="line">               d.primary_category_id AS primary_category_id,</span><br><span class="line">               d.primary_category_name AS primary_category_name,</span><br><span class="line">               d.secondary_category_id AS secondary_category_id,</span><br><span class="line">               d.secondary_category_name AS secondary_category_name,</span><br><span class="line">               d.cooperation_mode AS cooperation_mode,</span><br><span class="line">               d.merchant_id AS merchant_id,</span><br><span class="line">               d.osName AS osName,</span><br><span class="line">               d.channel_id AS channel_id,</span><br><span class="line">               (CASE WHEN d.channel_name IS NOT NULL THEN d.channel_name ELSE d.channel_id END) AS channel_name,</span><br><span class="line">               d.version AS version,</span><br><span class="line">               d.stat_date AS stat_date,</span><br><span class="line">               d.new_user_open AS new_user_open,</span><br><span class="line">               d.new_user_play AS new_user_play,</span><br><span class="line">               d.active_user_open AS active_user_open,</span><br><span class="line">               d.active_user_play AS active_user_play,</span><br><span class="line">               d.old_user_open AS old_user_open,</span><br><span class="line">               d.old_user_play AS old_user_play,</span><br><span class="line">               d.average_time AS average_time,</span><br><span class="line">               d.new_user_average_time AS new_user_average_time,</span><br><span class="line">               d.old_user_average_time AS old_user_average_time,</span><br><span class="line">               d.new_user_open_2retention AS new_user_open_2retention,</span><br><span class="line">               d.new_user_open_3retention AS new_user_open_3retention,</span><br><span class="line">               d.new_user_open_7retention AS new_user_open_7retention,</span><br><span class="line">               d.new_user_open_15retention AS new_user_open_15retention,</span><br><span class="line">               d.new_user_open_30retention AS new_user_open_30retention,</span><br><span class="line">               d.uninstall_cnt AS uninstall_cnt,</span><br><span class="line">               m.merchant_name AS merchant_name</span><br><span class="line">          FROM daily_app_user d </span><br><span class="line">          LEFT JOIN merchant m ON d.merchant_id=m.id </span><br><span class="line">          WHERE d.stat_date = #&#123;statDate&#125;</span><br><span class="line">          &lt;if test=&quot;osNames!=null&quot;&gt;</span><br><span class="line">               AND d.osName IN</span><br><span class="line">               &lt;foreach collection=&quot;osNames&quot; index=&quot;index&quot; item=&quot;osName&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">                    #&#123;osName&#125;</span><br><span class="line">               &lt;/foreach&gt;</span><br><span class="line">          &lt;/if&gt;</span><br><span class="line">          &lt;if test=&quot;channelNames!=null&quot;&gt;</span><br><span class="line">               AND</span><br><span class="line">               &lt;foreach collection=&quot;channelNames&quot; index=&quot;index&quot; item=&quot;channelName&quot; open=&quot; (&quot; separator=&quot; OR &quot; close=&quot;)&quot;&gt;</span><br><span class="line">                    (d.channel_name LIKE CONCAT(&apos;%&apos;, CONCAT(#&#123;channelName&#125;, &apos;%&apos;)))</span><br><span class="line">               &lt;/foreach&gt;</span><br><span class="line">          &lt;/if&gt;</span><br><span class="line">          &lt;if test=&quot;versions!=null&quot;&gt;</span><br><span class="line">               AND d.version IN</span><br><span class="line">               &lt;foreach collection=&quot;versions&quot; index=&quot;index&quot; item=&quot;version&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">                    #&#123;version&#125;</span><br><span class="line">               &lt;/foreach&gt;</span><br><span class="line">          &lt;/if&gt;</span><br><span class="line">          &lt;if test=&quot;merchantNames!=null&quot;&gt;</span><br><span class="line">               AND</span><br><span class="line">               &lt;foreach collection=&quot;merchantNames&quot; index=&quot;index&quot; item=&quot;merchantName&quot; open=&quot; (&quot; separator=&quot; OR &quot; close=&quot;)&quot;&gt;</span><br><span class="line">                    (m.merchant_name LIKE CONCAT(&apos;%&apos;, CONCAT(#&#123;%merchantName%&#125;, &apos;%&apos;)))</span><br><span class="line">               &lt;/foreach&gt;</span><br><span class="line">          &lt;/if&gt;</span><br><span class="line">          &lt;if test=&quot;primaryCategories!=null&quot;&gt;</span><br><span class="line">               AND d.primary_category_id IN</span><br><span class="line">               &lt;foreach collection=&quot;primaryCategories&quot; index=&quot;index&quot; item=&quot;primaryCategory&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">                    #&#123;primaryCategory&#125;</span><br><span class="line">               &lt;/foreach&gt;</span><br><span class="line">          &lt;/if&gt;</span><br><span class="line">          &lt;if test=&quot;secondaryCategories!=null&quot;&gt;</span><br><span class="line">               AND d.secondary_category_id IN</span><br><span class="line">               &lt;foreach collection=&quot;secondaryCategories&quot; index=&quot;index&quot; item=&quot;secondaryCategory&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">                    #&#123;secondaryCategory&#125;</span><br><span class="line">               &lt;/foreach&gt;</span><br><span class="line">          &lt;/if&gt;</span><br><span class="line">          &lt;if test=&quot;cooperationModes!=null&quot;&gt;</span><br><span class="line">               AND d.cooperation_model IN</span><br><span class="line">               &lt;foreach collection=&quot;cooperationModes&quot; index=&quot;index&quot; item=&quot;cooperationMode&quot; open=&quot; (&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">                    #&#123;cooperationMode&#125;</span><br><span class="line">               &lt;/foreach&gt;</span><br><span class="line">          &lt;/if&gt;</span><br><span class="line">     &lt;/sql&gt;</span><br><span class="line">      </span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>

<p>上述映射配置对应的Mapper定义，接口如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package org.shirdrn.data.mappers;</span><br><span class="line"> </span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"> </span><br><span class="line">import org.shirdrn.data.beans.DailyAppUser;</span><br><span class="line"> </span><br><span class="line">public class DailyAppUserMapper &#123;</span><br><span class="line"> </span><br><span class="line">     List&lt;DailyAppUser&gt; getDailyAppUserListByPage(Map&lt;String, Object&gt; conditions);</span><br><span class="line">     List&lt;DailyAppUser&gt; getDailyAppUserListForReport(Map&lt;String, Object&gt; conditions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要说明的是，如果多个表，一定要设置好Mapper映射配置中每个select元素的resultMap属性，属性值就是前部分的resultMap定义的id。如果只从单个表查询数据，完全可以使用resultType，对应resultMap元素中配置的type属性所指定的别名。<br>实际上，我们需要通过Map来传递参数，也就是把查询的条件值都收集起来，然后放到Map中，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; conditions = new HashMap&lt;String, Object&gt;();</span><br><span class="line">if(osNames != null) &#123;</span><br><span class="line">     conditions.put(DailyAppUserMapper.KEY_OS_NAMES, osNames);</span><br><span class="line">&#125;</span><br><span class="line">if(channelNames != null) &#123;</span><br><span class="line">     conditions.put(DailyAppUserMapper.KEY_CHANNEL_NAMES, channelNames);</span><br><span class="line">&#125;</span><br><span class="line">if(versions != null) &#123;</span><br><span class="line">     conditions.put(DailyAppUserMapper.KEY_VERSIONS, versions);</span><br><span class="line">&#125;</span><br><span class="line">if(merchantNames != null) &#123;</span><br><span class="line">     conditions.put(DailyAppUserMapper.KEY_MERCHANT_NAMES, merchantNames);</span><br><span class="line">&#125;</span><br><span class="line">if(primaryCategories != null) &#123;</span><br><span class="line">     conditions.put(DailyAppUserMapper.KEY_PRIMARY_CATEGORIES, primaryCategories);</span><br><span class="line">&#125;</span><br><span class="line">if(secondaryCategories != null) &#123;</span><br><span class="line">     conditions.put(DailyAppUserMapper.KEY_SECONDARY_CATEGORIES, secondaryCategories);</span><br><span class="line">&#125;</span><br><span class="line">if(cooperationModes != null) &#123;</span><br><span class="line">     conditions.put(ChannelDayMapper.KEY_COOPERATION_MODES, cooperationModes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面对应的DailyAppUserMapper中定义的一些Key常量名称，要和Mapper配置文件中foreach元素的collection属性值一致。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>Copyright： </strong>
              Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://yoursite.com/Mybatis-动态sql/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code/">code</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/分布式开发/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            分布式开发基础
          
        </div>
      </a>
    
    
      <a href="/docker/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">docker</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: '',
        app_key: '',
        path: window.location.pathname,
        notify: 'false',
        verify: 'false',
        avatar: 'mp',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2018-2020
        Leon
      </li>
      <li>
        
        Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <span>
  <i>PV:<span id="busuanzi_value_page_pv"></span></i>
  <i>UV:<span id="busuanzi_value_site_uv"></span></i>
</span>
        
      </li>
      
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hackerrank.svg" alt="Leon"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/旅行/">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="http://shenyu-vip.lofter.com">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Suche">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i></p>
  <div class="reward-box">
    
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['人生如逆旅，我亦是行人', '不要忘记25岁，你想成为什么样的人', '腹有诗书气自华'],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
  }

</script>



<script src="/js/tocbot.min.js"></script>
<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/dist/main.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>




<script src="/js/busuanzi-2.3.pure.min.js"></script>


<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>


    
  </div>
</body>

</html>